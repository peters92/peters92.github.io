<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>NYC Crimes by Borough</title>
		<script type="text/javascript" src="/d3/d3.js"></script>
		<script src="/d3/d3-scale-chromatic.v1.min.js"></script>
		<style type="text/css">

			.doughnut_title {
				text-anchor: middle;
				font-family: Helvetica, sans-serif;
				font-size: 18px;
				fill: black;
			}
			[class^="label"]{
				pointer-events: none;
				font-family: Helvetica, sans-serif;
				font-size: 14px;
				fill: white;
			}
			.boro_name{
				text-anchor: middle;
				font-family: Helvetica, sans-serif;
				font-size: 22px;
				font-weight: bold;
				fill: black;
			}

		</style>
	</head>
	<body>
		
		<div id="doughnut_div">
		<script type="text/javascript">

			//Margins and size for doughnut chart SVG
			var margin_dn = {top: 150, right: 150, bottom: 150, left: 150};
			var w = 600 - margin_dn.left - margin_dn.right;
			var h = 600 - margin_dn.top - margin_dn.bottom;

			//Number of crime complaints per borough (calculated previously in Matlab)
			var crime_per_boro = [103750, 137851, 112919, 92392, 21378];
			var boros = [ 'Bronx',
								    'Brooklyn',
								    'Manhattan',
										'Queens',
										'Staten Island'];
			//Calculating fraction compared to total number of crime complaints
			var crime_sum = d3.sum(crime_per_boro);
			var fractions = [];
			for (var i=0; i<crime_per_boro.length; i++)
				{
					fractions.push(crime_per_boro[i]/crime_sum);
				}

			//Doughnut sizes and arc
			var outerRadius = w * 0.7;
			var innerRadius = w * 0.5;
			var arc = d3.arc()
						.innerRadius(innerRadius)
						.outerRadius(outerRadius);

			var pie = d3.pie();

			//Doughnut chart colors, needs d3-scale-chromatic library
			var color_doughnut = d3.scaleOrdinal(d3.schemeCategory10);

			//Create SVG element
			var svg_doughnut = d3.select("body")
						.append("svg")
						.attr("width", w + margin_dn.left + margin_dn.right)
						.attr("height", h + margin_dn.top + margin_dn.bottom);

			//Set up groups
			var arcs = svg_doughnut.selectAll("g.arc")
						  .data(pie(crime_per_boro))
						  .enter()
						  .append("g")
						  .attr("class", "arc")
							.attr('id', function(d,i){
								return i;
							})
						  .attr("transform", "translate(" + (margin_dn.left+outerRadius) + "," + (margin_dn.right+outerRadius) + ")");

			//Draw arc paths
			var arc_paths = arcs.append("path")
													.attr('class','arcpath')
													.attr('id', function(d,i){
														return i;
													})
											    .attr("fill", function(d, i) {
											    	return color_doughnut(i);
											    })
											    .attr("d", arc);
			//Minimalist browser built-in tooltips, not needed anymore
			/*arc_paths.append("title")
					.text(function(d,i) {
					return 'Number of crimes in ' + boros[i] + ' in 2016: ' + d.value;
					});*/

			//Labels
			format = d3.format("0.1%");

			arcs.append("text")
					.attr("class",function(d,i){
						return "label"+i;
					})
			    .attr("transform", function(d) {
			    	return "translate(" + arc.centroid(d) + ")";
			    })
			    .attr("text-anchor", "middle")
			    .text(function(d,i) {
			    	return format(fractions[i]);
			    });

			//Adding Text to the middle of the chart
			doughnut_title = arcs.append("g")
														.attr("class","doughnut_title_box");
			doughnut_title.append("text")
					.attr('class', 'doughnut_title')
					.text("Crimes in NYC - 2016");

			boro_name = arcs.append("text")
					.attr("class","boro_name")
					.attr("opacity", 0);

			//Mouseover events
			d3.selectAll('.arcpath')
				.on('mouseover', doughnut_hover);
			d3.selectAll('.arcpath')
				.on('mouseout', doughnut_hover_over);

			function doughnut_hover()
				{
					var dur=500;
					var id = this.id;
					arc.innerRadius(innerRadius*1.1)
							.outerRadius(outerRadius*1.07);
					d3.select(this)
						.transition()
						.duration(dur)
						.attr('d', arc)
					arcs.select(".label"+this.id)
						.transition()
						.duration(dur)
						.attr("transform", function(d) {
				    	return "translate(" + arc.centroid(d) + ")";
				    })
						.style('font-size', '16px')
						.attr('font-weight', 'bold');
					//Move default title up a bit
					d3.selectAll(".doughnut_title_box")
						.transition()
						.duration(dur)
						.attr("transform","translate(0,-20)");
					//Create new text element with borough name
					boro_name.transition()
									.duration(dur)
									.delay(75)
									.attr("opacity", 1)
									.attr("transform","translate(0,30)")
									.text(function(){return crime_per_boro[id]});
					d3.selectAll(".doughnut_title")
						.text(function(){return "NYPD Complaints in " + boros[id] + ":"})

				}
			function doughnut_hover_over()
				{
					arc.innerRadius(innerRadius)
							.outerRadius(outerRadius);

					var dur=500;
					d3.select(this)
						.transition()
						.duration(dur)
						.attr('d', arc)
					arcs.select(".label"+this.id)
						.transition()
						.duration(dur)
						.attr("transform", function(d) {
				    	return "translate(" + arc.centroid(d) + ")";
				    })
						.style('font-size', '14px')
						.attr('font-weight', 'normal')

					//Move default title back
					d3.selectAll(".doughnut_title_box")
						.transition()
						.delay(100)
						.duration(dur)
						.attr("transform","translate(0,0)");

					//Remove boro
					arcs.selectAll(".boro_name")
						.transition()
						.delay(50)
						.duration(dur)
						.attr("opacity", 0)
						.attr("transform","translate(0,0)");
					d3.selectAll(".doughnut_title")
						.text("Crimes in NYC - 2016");

				}

		</script>
		</div>
	</body>
</html>
