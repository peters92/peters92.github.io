<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>NYC Crimes by Borough</title>
		<script type="text/javascript" src="/d3/d3.js"></script>
		<script src="/d3/d3-scale-chromatic.v1.min.js"></script>
		<style type="text/css">

			.doughnut_title {
				text-anchor: middle;
				font-family: Helvetica, sans-serif;
				font-size: 18px;
				fill: black;
			}
			[class^="label"]{
				pointer-events: none;
				font-family: Helvetica, sans-serif;
				font-size: 14px;
				fill: white;
			}
			.boro_name{
				text-anchor: middle;
				font-family: Helvetica, sans-serif;
				font-size: 22px;
				font-weight: bold;
				fill: black;
			}

		</style>
	</head>
	<body>
		<div id="crime_stack_chart_div">
		<script type="text/javascript">

			//Margins and size for stacked area chart SVG
			var margin_st = {top: 50, right: 20, bottom: 20, left: 20};
			var w_st = 700 - margin_st.left - margin_st.right;
			var h_st = 400 - margin_st.top - margin_st.bottom;

			//Doughnut chart colors, needs d3-scale-chromatic library
			var color_stack = d3.scaleOrdinal(d3.schemeCategory10);

			//Create SVG element
			var svg_stack_chart = d3.select("body")
						.append("svg")
						.attr("width", w_st + margin_st.left + margin_st.right)
						.attr("height", h_st + margin_st.top + margin_st.bottom)
						.attr("transform", "translate("+margin_st.left+","+margin_st.top+")");

			//Loading data from csv
			var dataset_stack, dataset, xScale_stack, yScale_stack, xAxis_stack, yAxis_stack;
			var months = [];
			var max_vals = [];


			d3.csv('/data/top5_crimes_manhattan_2016.csv', function(data)
			{
				dataset = data;
				var stack = d3.stack()
											.keys(dataset.columns.slice(1))
											.order(d3.stackOrderDescending);
				dataset_stack = stack(dataset);

				for (var i=0; i<12; i++)
				{
					//months.push(dataset_stack[i].months);
					months.push(i+1);
					max_vals.push(dataset_stack[0][i][1]);
				}
				var max_val = d3.max(max_vals);
				xScale_stack = d3.scaleBand()
													.domain(months)
													.rangeRound([0, w_st]);
				yScale_stack = d3.scaleLinear()
													.domain([0, max_val])
													.range([h_st,0])
													.nice();

				xAxis_stack = d3.axisBottom()
						   .scale(xScale_stack)
						   .ticks(12);

				//Define Y axis
				yAxis_stack = d3.axisRight()
						   .scale(yScale_stack)
						   .ticks(5);

				 //Define area generator
 				area = d3.area()
 							.x(function(d,i) { return xScale_stack(months[i]); })
 							.y0(function(d) { return yScale_stack(d[0]); })
 							.y1(function(d) { return yScale_stack(d[1]); });

				svg_stack_chart.selectAll("path")
												.data(dataset_stack)
												.enter()
												.append("path")
												.attr("class", "area")
												.attr("d", area)
												.attr("fill", function(d, i) {
													return d3.schemeCategory20[i];
												})
												.append("title")  //Make tooltip
												.text(function(d) {
													return d.key;
												});
				//Create axes
				svg_stack_chart.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0," + (h_st) + ")")
					.call(xAxis_stack);

				svg_stack_chart.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(" + (w_st) + ",0)")
					.call(yAxis_stack);
			})


		</script>
		</div>
		<div id="doughnut_div">
		<script type="text/javascript">

			//Margins and size for doughnut chart SVG
			var margin_dn = {top: 50, right: 100, bottom: 100, left: 50};
			var w = 500 - margin_dn.left - margin_dn.right;
			var h = 500 - margin_dn.top - margin_dn.bottom;

			//Number of crime complaints per borough (calculated previously in Matlab)
			var crime_per_boro = [103750, 137851, 112919, 92392, 21378];
			var boros = [ 'Bronx',
								    'Brooklyn',
								    'Manhattan',
										'Queens',
										'Staten Island'];
			//Calculating fraction compared to total number of crime complaints
			var crime_sum = d3.sum(crime_per_boro);
			var fractions = [];
			for (var i=0; i<crime_per_boro.length; i++)
				{
					fractions.push(crime_per_boro[i]/crime_sum);
				}

			//Doughnut sizes and arc
			var outerRadius = w * 0.55;
			var innerRadius = w * 0.4;
			var arc = d3.arc()
						.innerRadius(innerRadius)
						.outerRadius(outerRadius);

			var pie = d3.pie();

			//Doughnut chart colors, needs d3-scale-chromatic library
			var color_doughnut = d3.scaleOrdinal(d3.schemeCategory10);

			//Create SVG element
			var svg_doughnut = d3.select("body")
						.append("svg")
						.attr("width", w + margin_dn.left + margin_dn.right)
						.attr("height", h + margin_dn.top + margin_dn.bottom)
						.attr("transform","translate("+margin_dn.left+","+margin_dn.top+")");

			//Set up groups
			var arcs = svg_doughnut.selectAll("g.arc")
						  .data(pie(crime_per_boro))
						  .enter()
						  .append("g")
						  .attr("class", "arc")
							.attr('id', function(d,i){
								return i;
							})
						  .attr("transform", "translate(" + (1.5*outerRadius) + "," + (1.5*outerRadius) + ")");

			//Draw arc paths
			var arc_paths = arcs.append("path")
													.attr('class','arcpath')
													.attr('id', function(d,i){
														return i;
													})
											    .attr("fill", function(d, i) {
											    	return color_doughnut(i);
											    })
											    .attr("d", arc);

			//Labels
			format = d3.format("0.1%");

			arcs.append("text")
					.attr("class",function(d,i){
						return "label"+i;
					})
			    .attr("transform", function(d) {
			    	return "translate(" + arc.centroid(d) + ")";
			    })
			    .attr("text-anchor", "middle")
			    .text(function(d,i) {
			    	return format(fractions[i]);
			    });

			//Adding Text to the middle of the chart
			doughnut_title = arcs.append("g")
														.attr("class","doughnut_title_box");
			doughnut_title.append("text")
					.attr('class', 'doughnut_title')
					.text("Crimes reported in NYC (2016)");

			boro_name = arcs.append("text")
					.attr("class","boro_name")
					.attr("opacity", 0);

			//Mouseover events
			d3.selectAll('.arcpath')
				.on('mouseover', doughnut_hover);
			d3.selectAll('.arcpath')
				.on('mouseout', doughnut_hover_over);

			function doughnut_hover()
				{
					var dur=500;
					var id = this.id;
					arc.innerRadius(innerRadius*1.1)
							.outerRadius(outerRadius*1.07);
					d3.select(this)
						.transition()
						.duration(dur)
						.attr('d', arc)
					arcs.select(".label"+this.id)
						.transition()
						.duration(dur)
						.attr("transform", function(d) {
				    	return "translate(" + arc.centroid(d) + ")";
				    })
						.style('font-size', '16px')
						.attr('font-weight', 'bold');
					//Move default title up a bit
					d3.selectAll(".doughnut_title_box")
						.transition()
						.duration(dur)
						.attr("transform","translate(0,-20)");
					//Create new text element with borough name
					tmp_format=d3.format(",r");
					boro_name.transition()
									.duration(dur)
									.delay(75)
									.attr("opacity", 1)
									.attr("transform","translate(0,30)")
									.text(function(){return boros[id] + ": " + tmp_format(crime_per_boro[id])});
					d3.selectAll(".doughnut_title")
						.text( "Number of NYPD Complaints")

				}
			function doughnut_hover_over()
				{
					arc.innerRadius(innerRadius)
							.outerRadius(outerRadius);

					var dur=500;
					d3.select(this)
						.transition()
						.duration(dur)
						.attr('d', arc)
					arcs.select(".label"+this.id)
						.transition()
						.duration(dur)
						.attr("transform", function(d) {
				    	return "translate(" + arc.centroid(d) + ")";
				    })
						.style('font-size', '14px')
						.attr('font-weight', 'normal')

					//Move default title back
					d3.selectAll(".doughnut_title_box")
						.transition()
						.delay(100)
						.duration(dur)
						.attr("transform","translate(0,0)");

					//Remove boro
					arcs.selectAll(".boro_name")
						.transition()
						.delay(50)
						.duration(dur)
						.attr("opacity", 0)
						.attr("transform","translate(0,0)");
					d3.selectAll(".doughnut_title")
						.text("Crimes reported in NYC (2016)");

				}

		</script>
		</div>
	</body>
</html>
